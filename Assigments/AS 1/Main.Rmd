---
title: "Assigment 1"
output: github_document

---
```{css parameter,  echo=FALSE}
pre {
  max-height: 200px;
  overflow-y: auto;
  overflow-x: auto;
}

pre[class] {
  max-height: 100px;
}
```

```{r setup, include=TRUE, cache=TRUE, tidy=TRUE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment=NA)
knitr::opts_chunk$set(error = TRUE, cache = T)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, reticulate, here, haven, descriptr)
```

## Downloading the Raw Data
We start by downloading and processing the [HCRIS](https://github.com/Nixoncandiales/Econ771/tree/main/Assigments/AS%201/Code/HCRIS), [POS](https://github.com/Nixoncandiales/Econ771/tree/main/Assigments/AS%201/Code/POS), and [ACA](https://github.com/Nixoncandiales/Econ771/tree/main/Assigments/AS%201/Code/ACA) raw data sets. The processed data sets are located in the [**Output**]((https://github.com/Nixoncandiales/Econ771/tree/main/Assigments/AS%201/Output)) folder under `HCRIS_Data.txt`, `pos_lastyear.v12.dta`, and `acs_medicare.txt` . We import those data sets in our file and inspect them as follows.

```{r import-data-hcris, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
if (!exists("data_hcris")) data_hcris <- read.delim(here("Assigments", "As 1", "Output", "HCRIS", "HCRIS_Data.txt"))
ds_screener(data_hcris)
```
After a quick screening of the HCRIS data we can see the missing values are significantly high which suggest some variables are recorded differently across time and forms. It is of particular interest the variables `uncomp_care` and `tot_uncomp_care_charges` which are of our main interest. After reviewing the codebook we confirmed in fact these two variables are the same but coded different across forms. 

```{r import-data-pos, include=TRUE, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
if (!exists("data_pos")) data_pos <- read_stata(here("Assigments", "As 1", "Output", "POS", "pos_lastyear.v12.dta"))
ds_screener(data_pos)
```

From the provider of services data set we do not evidence missing data problems. We can observe if a particular POS went out of the market by either closing or merging and the respectively date of the event. It is to note the identifier variable is `pn` which is recorded as a character differs in the HCRIS data set `provider_number` which is coded as numerical. 

```{r import-data-medicaid, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
if (!exists("data_aca")) data_aca <- read.delim(here("Assigments", "As 1", "Output", "ACA", "acs_medicaid.txt"))
ds_screener(data_aca)
```

Finally, from the medicare data set we see the states that expanded the mandate and the date of event. Also, it is to note that the state identifier is not recorded in the same format across data sets.

### Summary Statistics
Provide and discuss a table of simple summary statistics showing the mean, standard deviation, min, and max of hospital total revenues and uncompensated care over time.

From the `HCRIS_data.txt` we select the variables `provider_number`, `year`, `uncomp_care`, `tot_uncomp_care_charges`, `tot_pat_rev` 

```{r select-data, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
data_hcris %>% 
  select(pn=provider_number, year, uncomp_care, tot_uncomp_care_charges, tot_pat_rev) %>% 
  as_tibble()
```
Then we group by year and calculate the summary statistics.

```{r summary-statistics-uncoomp-care, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA, warning=FALSE}
sum_unc_care <- data_hcris %>% 
  select(provider_number, year, uncomp_care, tot_uncomp_care_charges, tot_pat_rev) %>%
  mutate(tot_uncomp_care_charges = pmax(tot_uncomp_care_charges,uncomp_care, na.rm=TRUE)) %>%
  group_by(year) %>% 
  summarise(
    Mean = mean(tot_uncomp_care_charges, na.rm = TRUE), 
    SD = sd(tot_uncomp_care_charges, na.rm = TRUE), Min = min(tot_uncomp_care_charges, na.rm = TRUE), 
    Max = max(tot_uncomp_care_charges, na.rm = TRUE)
  ) %>% 
  drop_na(Mean)

sum_unc_care
```

```{r summary-statistics-tot-rev, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
sum_tot_rev <- data_hcris %>% 
  select(provider_number, year, tot_uncomp_care_charges, tot_pat_rev) %>% 
  group_by(year) %>% 
  summarise(
    Mean = mean(tot_pat_rev, na.rm = TRUE), 
    SD = sd(tot_pat_rev, na.rm = TRUE), Min = min(tot_pat_rev, na.rm = TRUE), 
    Max = max(tot_pat_rev, na.rm = TRUE)
  ) %>% 
  drop_na(Mean)

sum_tot_rev
```

```{r plot, tidy=TRUE, echo=TRUE, cache=TRUE, comment=NA}
plot1 <-
  sum_unc_care %>% 
  ggplot(aes(x = year, y = Mean)) + 
  geom_point()
plot1

plot2 <-
  sum_tot_rev %>% 
  ggplot(aes(x = year, y = Mean)) + 
  geom_point()
plot2
```

### By Ownership Type
Create a figure showing the mean hospital uncompensated care from 2000 to 2018. Show this trend separately by hospital ownership type (private not for profit and private for profit).
```{r, include=FALSE}
library(tidyverse)
```

```{r merge, warning=FALSE }
data_merged <- 
  left_join(data_hcris %>%
              mutate(unc_care = pmax(tot_uncomp_care_charges,uncomp_care, na.rm=TRUE)) %>% 
              select(pn=provider_number, year, unc_care, hos_rev=tot_pat_rev) %>% 
              as.tibble() %>%
              drop_na(unc_care)
            ,
            data_pos %>%
              select(pn, nonprofit, forprofit, govt) %>%
              mutate_at('pn', as.integer)
            ,
            by="pn") 
```

```{r echo=FALSE}
data_merged
```
```{r plot3, warning=FALSE }
data_merged %>%
  filter(year<=2018, nonprofit==1) %>%
  select(pn, year, unc_care, nonprofit) %>%
  group_by(year) %>%
  summarise(Mean = mean(unc_care, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = Mean)) + 
  geom_line() -> plot3
```

```{r echo=FALSE}
plot3
```

```{r plot4, warning=FALSE }
data_merged %>%
  filter(year<=2018, forprofit==1) %>%
  select(pn, year, unc_care, nonprofit) %>%
  group_by(year) %>%
  summarise(Mean = mean(unc_care, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = Mean)) + 
  geom_line() -> plot4
```

```{r echo=FALSE}
plot4
```

```{r delete, include=FALSE}
rm(data1,data2, sum_tot_rev, sum_unc_care)
```